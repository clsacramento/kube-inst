---
# CNI network configuration

 - name: copy calico yaml
   when: cni_network == "calico"
   copy: src=../files/calico.yaml dest=/tmp/.

 - name: deploy calico template
   when: cni_network == "calico"
   shell: "kubectl apply -f /tmp/calico.yaml"

 - name: wait for Calico deployment
   when: cni_network == "calico"
   shell: "kubectl get pods --all-namespaces | grep kube-dns"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 30
   delay: 10

 - name: copy Flannel yaml
   when: cni_network == "flannel"
   copy: src=../files/kube-flannel.yml dest=/tmp/.

 - name: deploy Flannel template
   when: cni_network == "flannel"
   shell: "kubectl apply -f /tmp/kube-flannel.yml"
   register: flannel
   changed_when: '"created" in flannel.stdout'

 - name: wait for Flannel deployment
   when: cni_network == "flannel"
   shell: "kubectl get pods --all-namespaces | grep kube-dns"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 30
   delay: 10
