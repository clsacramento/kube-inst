---

# Monitoring
 - name: copy Grafana, Heapster and InfluxDB
   when: deploy_monitoring == true
   copy:
     src: ./files/monitoring/
     dest: /tmp/monitoring/

 - name: deploy Grafana, Heapster and InfluxDB
   when: deploy_monitoring == true
   shell: "kubectl create -f /tmp/monitoring/"
   register: result
   changed_when: '"created" in result.stdout'

 - name: wait for Heapster deployment
   when: deploy_monitoring == true
   shell: "kubectl get pods -n kube-system | grep heapster"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 60
   delay: 10
   changed_when: false

 - name: wait for Grafana deployment
   when: deploy_monitoring == true
   shell: "kubectl get pods -n kube-system | grep grafana"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 60
   delay: 10
   changed_when: false

 - name: wait for InfluxDB deployment
   when: deploy_monitoring == true
   shell: "kubectl get pods -n kube-system | grep influxdb"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 60
   delay: 10
   changed_when: false

# Helm
 - name: copy Helm
   when: deploy_helm == true
   copy:
     src: ./files/helm.yaml
     dest: /tmp/helm.yaml

 - name: deploy Helm service
   when: deploy_helm == true
   shell: "kubectl create -f /tmp/helm.yaml"
   register: result
   changed_when: '"created" in result.stdout'

 - name: Download and unpack Helm client
   when: deploy_helm == true
   unarchive:
     src: https://kubernetes-helm.storage.googleapis.com/helm-v2.6.2-linux-amd64.tar.gz
     dest: /tmp
     remote_src: yes

 - name: Copy Helm client to PATH
   when: deploy_helm == true
   copy:
     src: /tmp/linux-amd64/helm
     dest: /usr/bin/helm
     remote_src: yes
   become: yes
   
 - name: Initialize Helm
   when: deploy_helm == true
   shell: "helm init --service-account helm"

 - name: wait for Helm service deployment
   when: deploy_helm == true
   shell: "kubectl get pods -n kube-system | grep tiller-deploy"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 60
   delay: 10
   changed_when: false

# Dashboard
 - name: copy Dashboard 
   when: deploy_dashboard == true
   copy:
     src: ./files/dashboard.yaml
     dest: /tmp/dashboard.yaml

 - name: deploy Dashboard
   when: deploy_dashboard == true
   shell: "kubectl apply -f /tmp/dashboard.yaml"
   register: dashboard
   changed_when: '"created" in dashboard.stdout'

 - name: wait for Dashboard deployment
   when: deploy_dashboard == true
   shell: "kubectl get pods -n kube-system | grep kubernetes-dashboard"
   register: result
   until: result.stdout.find("Running") != -1
   retries: 30
   delay: 10

# Demo App

 - name: deploy sock-shop
   when: deploy_demo_app == true
   shell: "{{ item }}"
   with_items:
   - "kubectl create namespace sock-shop"
   - 'kubectl apply -n sock-shop -f "https://github.com/microservices-demo/microservices-demo/blob/master/deploy/kubernetes/complete-demo.yaml?raw=true"'
   register: sock_shop
   changed_when: '"created" in sock_shop.stdout'

 - name: wait for sock-shop deployment
   when: deploy_demo_app == true
   shell: "kubectl get pods -n sock-shop --no-headers=true | grep -ivw running || true"
   register: result
   until: result.stdout == ""
   retries: 60
   delay: 10
   changed_when: false

#
#
# - name: copy jenkins yaml
#   copy: src=./files/jenkins.yaml dest=/tmp/jenkins.yaml
#   become: yes
#
# - name: deploy jenkins template
#   shell: "kubectl apply -f /tmp/jenkins.yaml"
#   register: jenkins
#   changed_when: '"created" in jenkins.stdout'
#
# - name: wait for jenkins deployment
#   shell: "while ! kubectl get pods --all-namespaces | grep jenkins | grep running -i | grep '1/1' -q; do sleep 5; done"
#   changed_when: false
#
# - name: copy registry yaml
#   copy: src=./files/registry.yaml dest=/tmp/registry.yaml
#   become: yes
#
# - name: deploy registry template
#   shell: "kubectl apply -f /tmp/registry.yaml"
#   register: registry
#   changed_when: '"created" in registry.stdout'
#
# - name: wait for registry deployment
#   shell: "while ! kubectl get pods --all-namespaces | grep registry | grep -iq running; do sleep 5; done"
#   changed_when: false
#
# - name: get cluster info
#   shell: "kubectl cluster-info"
#   register: clusterinfo
#   changed_when: false
#
# - name: show cluster info
#   debug: msg="{{ item }}"
#   with_items: 
#     - "{{ clusterinfo.stdout_lines }}"
#
# - name: get jenkins password
#   shell: "kubectl exec -n kube-system $(kubectl get pods -n kube-system --selector=app=jenkins --output=jsonpath={.items..metadata.name}) -- cat /root/.jenkins/secrets/initialAdminPassword"
#   register: jenkins_password
#   changed_when: false
#
# - name: show jenkins password
#   debug: var=jenkins_password.stdout
#
# - name: save jenkins password
#   local_action: copy content={{ jenkins_password.stdout }} dest=~/jenkins_password
